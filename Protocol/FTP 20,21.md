#FTP
# Knowledge
## FTP (File Transfer Protocol)

One of the oldest Internet protocols, operating within the application layer of the `TCP/IP stack`. It establishes control and data channels through TCP ports 21 and 20 respectively. FTP supports active/passive modes, various commands, and status codes for file management. Requires credentials for access, though some servers may offer restricted anonymous FTP. Vulnerable to sniffing as it operates as a clear-text protocol.

## TFTP (Trivial File Transfer Protocol)
#TFTP
Simpler than FTP, uses `UDP`, lacks user authentication, and advanced features. Access is limited by OS file permissions, making it suitable only for local and protected networks. Supports basic commands for file transfer but lacks directory listing functionality. Let us take a look at a few `commands of TFTP`:

|Command|Description|
|---|---|
|connect|Sets the remote host and, optionally, the port for file transfers.|
|get|Transfers file(s) from the remote host to the local host.|
|put|Transfers file(s) from the local host onto the remote host.|
|quit|Exits TFTP.|
|status|Shows the current status of TFTP, including transfer mode, connection status, timeout value, etc.|
|verbose|Turns verbose mode (additional information during file transfer) on or off.|

## Default Configuration
#configuration
One of the most used FTP servers on Linux-based distributions is [vsFTPd](https://security.appspot.com/vsftpd.html). The default configuration of vsFTPd can be found in `/etc/vsftpd.conf`, and some settings are already predefined by default.
#### Install vsFTPd
```shell
sudo apt install vsftpd 
```

#### vsFTPd Config File
```shell
cat /etc/vsftpd.conf | grep -v "#"
```

|Setting|Description|
|---|---|
|`listen`|Run from inetd or as a standalone daemon? (`NO` by default)|
|`listen_ipv6`|Listen on IPv6? (`YES` by default)|
|`anonymous_enable`|Enable Anonymous access? (`NO` by default)|
|`local_enable`|Allow local users to login? (`YES` by default)|
|`dirmessage_enable`|Display active directory messages when users go into certain directories? (`YES` by default)|
|`use_localtime`|Use local time? (`YES` by default)|
|`xferlog_enable`|Activate logging of uploads/downloads? (`YES` by default)|
|`connect_from_port_20`|Connect from port 20? (`YES` by default)|
|`secure_chroot_dir`|Name of an empty directory (`/var/run/vsftpd/empty` by default)|
|`pam_service_name`|The name of the PAM service vsftpd will use.|
|`rsa_cert_file`|Location of the RSA certificate to use for SSL encrypted connections.|
|`rsa_private_key_file`|Location of the RSA private key to use for SSL encrypted connections.|
|`ssl_enable`|Enable SSL? (`NO` by default)|

In addition, there is a file called `/etc/ftpusers` that we also need to pay attention to, as this file is used to deny certain users access to the FTP service.

```shell
cat /etc/ftpusers

guest
```

## Dangerous Settings
#settings
FTP servers offer numerous security-related configurations to test connections, routes, and authentication methods. Among these mechanisms is the anonymous user, commonly used within internal networks to facilitate file and data sharing without direct access to individual computers. For vsFTPd, configuration settings for anonymous login include:

|Setting|Description|
|---|---|
|`anonymous_enable=YES`|Allowing anonymous login?|
|`anon_upload_enable=YES`|Allowing anonymous to upload files?|
|`anon_mkdir_write_enable=YES`|Allowing anonymous to create new directories?|
|`no_anon_password=YES`|Do not ask anonymous for a password?|
|`anon_root=/home/username/ftp`|Directory for anonymous.|
|`write_enable=YES`|Allow the usage of FTP commands: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, and SITE?|

- Access via FTP Client: Using the standard FTP client (`ftp`) allows access to the FTP server with the configured `anonymous user` if the aforementioned settings have been applied.
- Usage in Internal Environments: The anonymous account is utilized in known internal environments or infrastructures where participants are recognized. This facilitates file exchange, either temporarily or as a consistent setting.
- vsFTPd Server Connection:
    - Response Code: Upon connection to the vsFTPd server, it responds with the `code 220`, displaying the FTP server `banner`.
    - Banner Content: The banner typically contains `service description`, `version details`, and the `system type` of the FTP server.
- Anonymous Access Configuration:
    - Common Configuration: Many FTP servers are configured to `allow anonymous access`, granting access to certain files without requiring legitimate credentials.
    - Access Benefits: Even if downloading files is restricted, listing the file contents can provide valuable insights, aiding in generating ideas or collecting information for alternative approaches.

# Interact with FTP
#management
#### Anonymous Login
```shell
ftp 10.189.114.136

Connected to 10.129.14.136.
220 "Welcome to the vsFTP service."
Name (10.129.14.136:cry0l1t3): anonymous

230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.


ftp> ls

200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
-rw-rw-r--    1 1002     1002      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Clients
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Employees
-rw-rw-r--    1 1002     1002           41 Sep 14 16:45 Important Notes.txt
226 Directory send OK.
```

#### vsFTPd Status
```shell
ftp> status

Connected to 10.129.14.136.
No proxy connection.
Connecting using address family: any.
Mode: stream; Type: binary; Form: non-print; Structure: file
Verbose: on; Bell: off; Prompting: on; Globbing: on
Store unique: off; Receive unique: off
Case: off; CR stripping: on
Quote control characters: on
Ntrans: off
Nmap: off
Hash mark printing: off; Use of PORT cmds: on
Tick counter printing: off
```

#### vsFTPd Detailed Output
```shell
ftp> debug

Debugging on (debug=1).


ftp> trace

Packet tracing on.


ftp> ls

---> PORT 10,10,14,4,188,195
200 PORT command successful. Consider using PASV.
---> LIST
150 Here comes the directory listing.
-rw-rw-r--    1 1002     1002      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 1002     1002         4096 Sep 14 17:03 Clients
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Employees
-rw-rw-r--    1 1002     1002           41 Sep 14 16:45 Important Notes.txt
226 Directory send OK.
```

|Setting|Description|
|---|---|
|`dirmessage_enable=YES`|Show a message when users enter a new directory?|
|`chown_uploads=YES`|Change ownership of anonymously uploaded files?|
|`chown_username=username`|User given ownership of anonymously uploaded files.|
|`local_enable=YES`|Enable local users to log in?|
|`chroot_local_user=YES`|Place local users into their home directory?|
|`chroot_list_enable=YES`|Use a list of local users to be placed in their home directory?|

#### Hiding IDs - YES

|Setting|Description|
|---|---|
|`hide_ids=YES`|All user and group information in directory listings displayed as “ftp”.|
|`ls_recurse_enable=YES`|Allows the use of recursive listings.|

In the following example, we can see that if the `hide_ids=YES` setting is present, the `UID` and `GUID` representation of the service will be overwritten, making it more difficult for us to identify with which rights these files are written and uploaded.

```shell
ftp> ls

---> TYPE A
200 Switching to ASCII mode.
ftp: setsockopt (ignored): Permission denied
---> PORT 10,10,14,4,223,101
200 PORT command successful. Consider using PASV.
---> LIST
150 Here comes the directory listing.
-rw-rw-r--    1 ftp     ftp      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 ftp     ftp         4096 Sep 14 17:03 Clients
drwxrwxr-x    2 ftp     ftp         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 ftp     ftp         4096 Sep 14 16:50 Employees
-rw-rw-r--    1 ftp     ftp           41 Sep 14 16:45 Important Notes.txt
-rw-------    1 ftp     ftp            0 Sep 15 14:57 testupload.txt
226 Directory send OK.
```

This setting is a security feature to prevent local usernames from being revealed. With the usernames, we could attack the services like FTP and SSH and many others with a brute-force attack in theory.

#### Recursive Listing
Another helpful setting we can use for our purposes is the `ls_recurse_enable=YES`. This is often set on the vsFTPd server to have a better overview of the FTP directory structure, as it allows us to see all the visible content at once.

```shell
ftp> ls -R

---> PORT 10,10,14,4,222,149
200 PORT command successful. Consider using PASV.
---> LIST -R
150 Here comes the directory listing.
.:
-rw-rw-r--    1 ftp      ftp      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 ftp      ftp         4096 Sep 14 17:03 Clients
drwxrwxr-x    2 ftp      ftp         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 ftp      ftp         4096 Sep 14 16:50 Employees
-rw-rw-r--    1 ftp      ftp           41 Sep 14 16:45 Important Notes.txt
-rw-------    1 ftp      ftp            0 Sep 15 14:57 testupload.txt

./Clients:
drwx------    2 ftp      ftp          4096 Sep 16 18:04 HackTheBox
drwxrwxrwx    2 ftp      ftp          4096 Sep 16 18:00 Inlanefreight

./Clients/HackTheBox:
-rw-r--r--    1 ftp      ftp         34872 Sep 16 18:04 appointments.xlsx
-rw-r--r--    1 ftp      ftp        498123 Sep 16 18:04 contract.docx
-rw-r--r--    1 ftp      ftp        478237 Sep 16 18:04 contract.pdf
-rw-r--r--    1 ftp      ftp           348 Sep 16 18:04 meetings.txt

./Clients/Inlanefreight:
-rw-r--r--    1 ftp      ftp         14211 Sep 16 18:00 appointments.xlsx
-rw-r--r--    1 ftp      ftp         37882 Sep 16 17:58 contract.docx
-rw-r--r--    1 ftp      ftp            89 Sep 16 17:58 meetings.txt
-rw-r--r--    1 ftp      ftp        483293 Sep 16 17:59 proposal.pptx

./Documents:
-rw-r--r--    1 ftp      ftp         23211 Sep 16 18:05 appointments-template.xlsx
-rw-r--r--    1 ftp      ftp         32521 Sep 16 18:05 contract-template.docx
-rw-r--r--    1 ftp      ftp        453312 Sep 16 18:05 contract-template.pdf

./Employees:
226 Directory send OK.
```

#### Download a File
Downloading files from such an FTP server is one of the main features, as well as uploading files created by us. this paves the way for techniques such as `LFI` or `RCE`.

```shell
ftp> ls

200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
-rwxrwxrwx    1 ftp      ftp             0 Sep 16 17:24 Calendar.pptx
drwxrwxrwx    4 ftp      ftp          4096 Sep 16 17:57 Clients
drwxrwxrwx    2 ftp      ftp          4096 Sep 16 18:05 Documents
drwxrwxrwx    2 ftp      ftp          4096 Sep 16 17:24 Employees
-rwxrwxrwx    1 ftp      ftp            41 Sep 18 15:58 Important Notes.txt
226 Directory send OK.


ftp> get Important\ Notes.txt

local: Important Notes.txt remote: Important Notes.txt
200 PORT command successful. Consider using PASV.
150 Opening BINARY mode data connection for Important Notes.txt (41 bytes).
226 Transfer complete.
41 bytes received in 0.00 secs (606.6525 kB/s)


ftp> exit

221 Goodbye.
```

#### Download All Available Files
```shell
 wget -m --no-passive ftp://anonymous:anonymous@10.129.14.136

--2021-09-19 14:45:58--  ftp://anonymous:*password*@10.129.14.136/                                         
	     => ‘10.129.14.136/.listing’                                                                     
Connecting to 10.129.14.136:21... connected.                                                               
Logging in as anonymous ... Logged in!
==> SYST ... done.    ==> PWD ... done.
==> TYPE I ... done.  ==> CWD not needed.
==> PORT ... done.    ==> LIST ... done.                                                                 
12.12.1.136/.listing           [ <=>                                  ]     466  --.-KB/s    in 0s       
                                                                                                       
2021-09-19 14:45:58 (65,8 MB/s) - ‘10.129.14.136/.listing’ saved [466]                                     
--2021-09-19 14:45:58--  ftp://anonymous:*password*@10.129.14.136/Calendar.pptx   
	     => ‘10.129.14.136/Calendar.pptx’                                       
==> CWD not required.                                                           
==> SIZE Calendar.pptx ... done.                                                                                                                            
==> PORT ... done.    ==> RETR Calendar.pptx ... done.       

...SNIP...

2021-09-19 14:45:58 (48,3 MB/s) - ‘10.129.14.136/Employees/.listing’ saved [119]

FINISHED --2021-09-19 14:45:58--
Total wall clock time: 0,03s
Downloaded: 15 files, 1,7K in 0,001s (3,02 MB/s)
```

#### Upload a File
With the `PUT command`, we can upload files in the current folder to the FTP server.

```shell
ftp> put testupload.txt 

local: testupload.txt remote: testupload.txt
---> PORT 10,10,14,4,184,33
200 PORT command successful. Consider using PASV.
---> STOR testupload.txt
150 Ok to send data.
226 Transfer complete.


ftp> ls

---> TYPE A
200 Switching to ASCII mode.
---> PORT 10,10,14,4,223,101
200 PORT command successful. Consider using PASV.
---> LIST
150 Here comes the directory listing.
-rw-rw-r--    1 1002     1002      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 1002     1002         4096 Sep 14 17:03 Clients
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Employees
-rw-rw-r--    1 1002     1002           41 Sep 14 16:45 Important Notes.txt
-rw-------    1 1002     133             0 Sep 15 14:57 testupload.txt
226 Directory send OK.
```
#### Other Interaction
If necessary, we can, of course, use other applications such as `netcat` or `telnet` to interact with the FTP server.

```shell
nc -nv 10.129.14.136 21
```

```shell
telnet 10.129.14.136 21
```

It looks slightly different if the FTP server runs with TLS/SSL encryption. Because then we need a client that can handle TLS/SSL. For this, we can use the client openssl and communicate with the FTP server. The good thing about using `openssl` is that we can see the SSL certificate, which can also be helpful.

```shell
openssl s_client -connect 10.129.14.136:21 -starttls ftp
```

This is because the SSL certificate allows us to recognize the `hostname`, for example, and in most cases also an `email address` for the organization or company.
# Footprinting the Service
## Nmap FTP Scripts
#nmap
```shell
sudo nmap --script-updatedb
```

All the NSE scripts are located in `/usr/share/nmap/scripts/`, but on our systems, we can find them using a simple command on our system.
```shell
find / -type f -name ftp* 2>/dev/null | grep scripts
```

As we already know, the FTP server usually runs on the standard `TCP` `port 21`, which we can scan using Nmap. We also use the version scan (`-sV`), aggressive scan (`-A)`, and the default script scan (`-sC`) against our target 10.179.114.136.
```shell
sudo nmap -sV -p21 -sC -A 10.129.14.136
```

_Script Trace_
```shell
sudo nmap -sV -p21 -sC -A 10.179.114.136 --script-trace
```
## Mount FTP Directory
```bash
sudo apt-get install curlftpfs
mkdir /mnt/my_ftp
curlftpfs ftp-user:ftp-pass@my-ftp-location.local /mnt/my_ftp/

# To allow other users
curlftpfs -o allow_other ftp-user:ftp-pass@my-ftp-location.local /mnt/my_ftp/
```
# Brute Force
#brute-force
```bash
hydra -L users.txt -P passwords.txt -t 3 -s 21 IP ftp
```