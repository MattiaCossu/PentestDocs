#DNS
# Knowledge
`DNS`, an integral part of the Internet, facilitates access to web servers via `domain names` like bard.google.com or www.google.com, mapping them to `specific IP` addresses provided by hosting providers. It operates as a `system converting computer names` into IP addresses without a central database, resembling a vast library housing various phone books. This information disperses across thousands of name servers globally. <span class="underline">These distributed DNS servers translate domain names to IP addresses</span>, directing users to specific servers associated with a domain. Various types of DNS servers are employed worldwide to manage this functionality.

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Server Type</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>

<tbody>
<tr>
<td class="org-left">DNS Root Server</td>
<td class="org-left">Responsible for top-level domains (TLDs), queried if a name server fails to respond. They act as a central interface between users and internet content, linking domains and IP addresses. ICANN coordinates the 13 root servers globally.</td>
</tr>


<tr>
<td class="org-left">Authoritative Nameserver</td>
<td class="org-left">Holds authority for specific zones, responding only to queries within its responsibility. The information they provide is considered definitive. If such a server can't answer, the root name server steps in.</td>
</tr>


<tr>
<td class="org-left">Non-authoritative Nameserver</td>
<td class="org-left">Not accountable for a particular DNS zone but gathers information about specific zones through recursive or iterative DNS queries.</td>
</tr>


<tr>
<td class="org-left">Caching DNS Server</td>
<td class="org-left">Stores information from other name servers for a set duration, determined by the authoritative name server. These servers hold cached data.</td>
</tr>


<tr>
<td class="org-left">Forwarding Server</td>
<td class="org-left">Solely responsible for forwarding DNS queries to other DNS servers, handling only query redirection.</td>
</tr>


<tr>
<td class="org-left">Resolver</td>
<td class="org-left">Not authoritative but performs local name resolution on computers or routers. Resolvers aid in converting domain names to IP addresses without maintaining their own zone information.</td>
</tr>
</tbody>
</table>

DNS is mainly unencrypted. Devices on the local WLAN and Internet providers can therefore hack in and spy on DNS queries. Since this poses a privacy risk, there are now some solutions for DNS encryption. By default, IT security professionals apply `DNS over TLS` (`DoT`) or `DNS over HTTPS` (`DoH`) here. In addition, the network protocol `DNSCrypt` also encrypts the traffic between the computer and the name server.

Different `DNS records` are used for the DNS queries, which all have various tasks. Moreover, separate entries exist for different functions since we can set up mail servers and other servers for a domain.

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">DNS Record</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>

<tbody>
<tr>
<td class="org-left">A</td>
<td class="org-left">Returns the IPv4 address of the requested domain.</td>
</tr>


<tr>
<td class="org-left">AAAA</td>
<td class="org-left">Returns the IPv6 address of the requested domain.</td>
</tr>


<tr>
<td class="org-left">MX</td>
<td class="org-left">Identifies responsible mail servers for the domain.</td>
</tr>


<tr>
<td class="org-left">NS</td>
<td class="org-left">Specifies the domain's DNS servers (nameservers).</td>
</tr>


<tr>
<td class="org-left">TXT</td>
<td class="org-left">Versatile record containing various information. It's used for purposes like Google Search Console validation, SSL certificate validation, SPF and DMARC entries for mail traffic validation, and protection from spam.</td>
</tr>


<tr>
<td class="org-left">CNAME</td>
<td class="org-left">Serves as an alias, pointing one domain to the same location as another. For instance, if www.hackthebox.eu should direct to the same IP as hackthebox.eu, an A record is set for one and a CNAME record is created for the other.</td>
</tr>


<tr>
<td class="org-left">PTR</td>
<td class="org-left">Performs reverse lookup, translating IP addresses into valid domain names.</td>
</tr>


<tr>
<td class="org-left">SOA</td>
<td class="org-left">Provides information about the corresponding DNS zone and the administrative contact's email address. It signifies the start of a zone of authority and contains essential information about the zone's management.</td>
</tr>
</tbody>
</table>

## Default Configuration

There are many different configuration types for DNS.
All DNS servers work with three different types of hierarchical configuration files:

1.  `local` DNS configuration files
2.  `zone` files
3.  `reverse` name resolution files

The DNS server [Bind9](https://www.isc.org/bind/) is very often used on Linux-based distributions. Its local configuration file (named.conf) is roughly divided into two sections, firstly the options section for general settings and secondly the zone entries for the individual domains. The local configuration files are usually:

-   named.conf.local
-   named.conf.options
-   named.conf.log

The configuration file `named.conf` is divided into several options that control the behavior of the name server. A distinction is made between `global options` and `zone options`.

1.  _Local DNS Configuration_
```bash
cat /etc/bind/named.conf.local

//
// Do any local configuration here
//

// Consider adding the 1918 zones here, if they are not used in your
// organization
//include "/etc/bind/zones.rfc1918";
â€‹zone "domain.com" {
	type master;
	file "/etc/bind/db.domain.com";
	allow-update { key rndc-key; };
};
```

2.  _Zone Files_
Zone files define individual DNS zones and are usually dedicated to one domain, except for ISP and public DNS servers. They utilize the BIND file format, a standard in DNS server software. These text files include essential records like `SOA` and `NS`, ensuring completeness and accuracy. Any syntax error renders the entire file unusable, causing DNS queries for that zone to receive a SERVFAIL error. Essentially, zone files function as a structured phone book for DNS servers, detailing domain-to-IP address mappings following BIND format rules.
```bash
cat /etc/bind/db.domain.com

;
; BIND reverse data file for local loopback interface
;
$ORIGIN domain.com
$TTL 86400
@     IN     SOA    dns1.domain.com.     hostmaster.domain.com. (
					2001062501 ; serial
					21600      ; refresh after 6 hours
					3600       ; retry after 1 hour
					604800     ; expire after 1 week
					86400 )    ; minimum TTL of 1 day

	  IN     NS     ns1.domain.com.
	  IN     NS     ns2.domain.com.

	  IN     MX     10     mx.domain.com.
	  IN     MX     20     mx2.domain.com.

			 IN     A       10.129.14.5

server1      IN     A       10.129.14.5
server2      IN     A       10.129.14.7
ns1          IN     A       10.129.14.2
ns2          IN     A       10.129.14.3

ftp          IN     CNAME   server1
mx           IN     CNAME   server1
mx2          IN     CNAME   server2
www          IN     CNAME   server2
```
3. _Reverse Name Resolution Zone Files_
Indeed, for a `Fully Qualified Domain Name` (`FQDN`) to resolve to an IP address, the DNS server requires a reverse lookup file. This file utilizes `PTR` (Pointer) records to map the computer name (FQDN) to the last octet of an IP address, correlating it with the respective host. PTR records play a crucial role in the reverse translation of IP addresses into corresponding names, as highlighted in the table previously mentioned.
```bash
cat /etc/bind/db.10.129.14

;
; BIND reverse data file for local loopback interface
;
$ORIGIN 14.129.10.in-addr.arpa
$TTL 86400
@     IN     SOA    dns1.domain.com.     hostmaster.domain.com. (
					2001062501 ; serial
					21600      ; refresh after 6 hours
					3600       ; retry after 1 hour
					604800     ; expire after 1 week
					86400 )    ; minimum TTL of 1 day

	  IN     NS     ns1.domain.com.
	  IN     NS     ns2.domain.com.

5    IN     PTR    server1.domain.com.
7    IN     MX     mx.domain.com.
...SNIP...
```
## Dangerous Settings

DNS servers face various `vulnerabilities` that attackers exploit. Vulnerabilities targeting BIND9, for instance, are documented on `CVEdetails`. SecurityTrails also outlines popular attacks on DNS servers.

`Certain configurations` contribute to these vulnerabilities. DNS, being complex, is prone to errors, compelling administrators to implement temporary workarounds until an exact solution is found. Often, functionality takes precedence over security, prompting the release of elements to ensure parts of the infrastructure function as intended. This prioritization sometimes leads to misconfigurations and vulnerabilities within the system.

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Option</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>

<tbody>
<tr>
<td class="org-left">allow-query</td>
<td class="org-left">Specifies hosts permitted to send requests to the DNS server.</td>
</tr>


<tr>
<td class="org-left">allow-recursion</td>
<td class="org-left">Specifies hosts permitted to send recursive requests to the DNS server.</td>
</tr>


<tr>
<td class="org-left">allow-transfer</td>
<td class="org-left">Specifies hosts permitted to receive zone transfers from the DNS server.</td>
</tr>


<tr>
<td class="org-left">zone-statistics</td>
<td class="org-left">Gathers statistical data related to zones managed by the DNS server.</td>
</tr>
</tbody>
</table>

# Footprinting the Service

Footprinting DNS servers involves querying them to gather information about other name servers known to them. This is typically done using the `NS` (Name Server) record and specifying the DNS server to be queried using the "`@`" character. By doing so, one can identify additional DNS servers and query their records. However, these other servers might have distinct configurations and can be permanent for different zones.

1. _Querying Name Servers (NS Records)_
Retrieves the `NS` records for the domain "example.com", showcasing the authoritative name servers responsible for the domain.
```bash
nslookup -type=NS example.com
dig ns example.com @10.129.14.128
```

2.  _DIG - Version Query_
```bash
dig CH TXT version.bind 10.129.120.85
```

3.  _Querying ANY_
We can use the option `ANY` to view all available records. 
```bash
dig any example.com @10.129.14.128
```

4. _Querying A Records_
Fetches the IPv4 address (`A record`) associated with the domain "example.com".
```bash
nslookup example.com
```

5.  _Querying MX Records_
Retrieves the Mail Exchange (`MX`) records for the domain "example.com", specifying mail servers responsible for email delivery.
```bash
nslookup -type=MX example.com
```

6.  _Querying TXT Records_
Fetches the text records associated with the domain "example.com", commonly used for various purposes like `SPF`, `DMARC`, and `verification purposes`
```bash
nslookup -type=TXT example.com
```

7.  _Reverse DNS Lookup (PTR Records)_
Performs a reverse `DNS lookup` to find the domain associated with the given IP address.
```bash
nslookup <IP address>
```

8.  _Querying AXFR Zone Transfer_

`Zone transfer` in DNS involves transferring zones from one server to another, commonly occurring over `TCP` port `53` through `Asynchronous Full Transfer Zone` (`AXFR`). Given the criticality of DNS for businesses, maintaining identical zone files across multiple name servers is crucial. Changes made in one server's zone must be synchronized across all servers to ensure data consistency, achieved through zone transfer.

The primary name server holds the `original zone data`, while secondary servers are installed for `increased reliability`, `load distribution`, or `primary server protection`. Top-Level Domains (TLDs) often mandate multiple servers for Second Level Domains' zone files.

Entries in DNS are typically managed on the primary server, either through manual edits or automated dynamic updates from a database. Servers directly providing zone file synchronization are termed masters, while those obtaining data from masters are termed slaves. A primary server functions solely as a master, while a secondary server can serve as both a slave and a master.

Slaves periodically fetch the `SOA` (`Start of Authority`) record from the master, comparing serial numbers at refresh intervals (**typically one hour**). A higher serial number on the master's SOA indicates mismatched data sets between servers.
```bash
dig axfr example.com @10.129.14.128
```

AXFR Zone Transfer - Internal
If the administrator used a subnet for the `allow-transfer` option for testing purposes or as a workaround solution or set it to any, everyone would query the entire zone file at the DNS server. In addition, other zones can be queried, which may even show internal IP addresses and hostnames.
```bash
dig axfr internal.example.com @10.129.14.128
```

9.  _Subdomain Brute Forcing_
The individual A records with the hostnames can also be found out with the help of a brute-force attack.
```bash
for sub in $(cat /opt/useful/SecLists/Discovery/DNS/subdomains-top1million-110000.txt);do dig $sub.example.com @10.129.14.128 | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done
```

10. _Automation_
Many different tools can be used for this, and most of them work in the same way. One of these tools is, for example [DNSenum](https://github.com/fwaeytens/dnsenum).
```bash
dnsenum --dnsserver 10.129.14.128 --enum -p 0 -s 0 -o subdomains.txt -f /opt/useful/SecLists/Discovery/DNS/subdomains-top1million-110000.txt example.com
```
