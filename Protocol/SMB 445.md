#SMB 
# Knowledge
Server Message Block (`SMB`) is a client-server protocol governing access to files, directories, and network resources like printers. Initially part of OS/2’s LAN Manager, it’s chiefly used within the Windows OS, allowing newer systems to communicate with older ones. Samba, a free software project, extends SMB to Linux and Unix, enabling cross-platform communication.

SMB facilitates communication between clients and network participants to access shared files or services. Both parties must implement the protocol, exchange messages, and establish a `TCP-based` connection through a `three-way handshake`. An SMB server can offer parts of its file system as shares, with access rights defined by Access Control Lists (`ACL`). These ACLs grant specific permissions to users or user groups, independent of local server rights.
## Samba - linux
Samba bridges Unix and Windows via `Common Internet File System` (`CIFS`), an `SMB` “dialect.” SMB versions differ in Windows support and features. Samba’s v3 supports Active Directory, v4 serves as a domain controller. Hosts in a workgroup connect via NetBIOS/WINS for naming and data sharing. However, CIFS is the extension of the SMB protocol. So when we pass SMB commands over Samba to an older NetBIOS service, it usually connects to the Samba server over TCP ports 137, 138, 139, but CIFS uses TCP port 445 only. There are several versions of SMB, including outdated versions that are still used in specific infrastructures.

|SMB Version|Supported|Features|
|---|---|---|
|CIFS|Windows NT 4.0|Communicates through NetBIOS interface|
|SMB 1.0|Windows 2000|Direct TCP connection|
|SMB 2.0|Windows Vista, Windows Server 2008|Enhanced performance, improved message signing, caching feature|
|SMB 2.1|Windows 7, Windows Server 2008 R2|Locking mechanisms|
|SMB 3.0|Windows 8, Windows Server 2012|Multichannel connections, end-to-end encryption, remote storage access|
|SMB 3.0.2|Windows 8.1, Windows Server 2012 R2||
|SMB 3.1.1|Windows 10, Windows Server 2016|Integrity checking, AES-128 encryption|

Presently, Samba’s version 3 empowers full Active Directory membership, while version 4 operates as an Active Directory domain controller. In the network environment, hosts in a workgroup collaborate, facilitated by the NetBIOS/WINS for naming and data exchange purposes. With version 4, Samba even provides an Active Directory domain controller. It contains several so-called daemons for this purpose - which are Unix background programs. The SMB server daemon (`smbd`) belonging to Samba provides the first two functionalities, while the NetBIOS message block daemon (`nmbd`) implements the last two functionalities. The SMB service controls these two background programs.

We know that Samba is suitable for both Linux and Windows systems. In a network, each host participates in the same workgroup. A `workgroup` is a group name that identifies an arbitrary collection of computers and their resources on an SMB network. There can be multiple workgroups on the network at any given time. IBM developed an application `programming interface` (`API`) for networking computers called the `Network Basic Input/Output System` (`NetBIOS`).
# Default Configuration
#configuration
As we can imagine, Samba offers a wide range of settings that we can configure. Again, we define the settings via a text file where we can get an overview of some of the settings.

```shell
cat /etc/samba/smb.conf | grep -v "#\|\;"
[global]
   workgroup = DEV.INFREIGHT.LOCAL
   server string = DEVSMB
   log file = /var/log/samba/log.%m
   max log size = 1000
   logging = file
   panic action = /usr/share/samba/panic-action %d

   server role = standalone server
   obey pam restrictions = yes
   unix password sync = yes

   passwd program = /usr/bin/passwd %u
   passwd chat = *Enter\snew\s*\spassword:* %n\n *Retype\snew\s*\spassword:* %n\n *password\supdated\ssuccessfully* .

   pam password change = yes
   map to guest = bad user
   usershare allow guests = yes

[printers]
   comment = All Printers
   browseable = no
   path = /var/spool/samba
   printable = yes
   guest ok = no
   read only = yes
   create mask = 0700

[print$]
   comment = Printer Drivers
   path = /var/lib/samba/printers
   browseable = yes
   read only = yes
   guest ok = no
```

We see global settings and two shares that are intended for printers. The global settings are the configuration of the available SMB server that is used for all shares.

|Setting|Description|
|---|---|
|[sharename]|The name of the network share.|
|workgroup = WORKGROUP/DOMAIN|Workgroup that will appear when clients query.|
|path = _path/here_|The directory to which the user is to be given access.|
|server string = STRING|The string that will show up when a connection is initiated.|
|unix password sync = yes|Synchronize the UNIX password with the SMB password?|
|usershare allow guests = yes|Allow non-authenticated users to access the defined share?|
|map to guest = bad user|What to do when a user login request doesn’t match a valid UNIX user?|
|browseable = yes|Should this share be shown in the list of available shares?|
|guest ok = yes|Allow connecting to the service without using a password?|
|read only = yes|Allow users to read files only?|
|create mask = 0700|What permissions need to be set for newly created files?|
## Dangerous Settings
#settings
The settings outlined in the configuration hold sensitivity. For instance, enabling ’`browseable = yes`’ offers convenience to employees, allowing easy access and navigation through shared folders for organizational purposes. However, this convenience extends to potential attackers who, upon gaining access, can exploit this setting to explore sensitive contents, posing a security risk to the company’s data. This dual nature of settings highlights the trade-off between user convenience and `potential vulnerabilities`.

|Setting|Description|
|---|---|
|browseable = yes|Allow listing available shares in the current share?|
|read only = no|Forbid the creation and modification of files?|
|writable = yes|Allow users to create and modify files?|
|guest ok = yes|Allow connecting to the service without using a password?|
|enable privileges = yes|Honor privileges assigned to specific SID?|
|create mask = 0777|What permissions must be assigned to the newly created files?|
|directory mask = 0777|What permissions must be assigned to the newly created directories?|
|logon script = script.sh|Script to be executed on the user’s login?|
|magic script = script.sh|Script to be executed when the session is closed?|
|magic output = script.out|Location to store the output of the magic script?|

## Example Share
#shares
In creating a share like `[notes]` and others, applying the settings as listed can significantly impact the enumeration process. Settings, commonly employed for testing purposes, might persist within internal subnets or small team environments in larger departments, inadvertently granting broad access. Failure to reset these settings leads to unintended consequences, allowing easy browsing, inspection, and potential download of shared data, posing a significant security risk.

```shell
...SNIP...

[notes]
	  comment = CheckIT
	  path = /mnt/notes/

	  browseable = yes
	  read only = no
	  writable = yes
	  guest ok = yes

	  enable privileges = yes
	  create mask = 0777
	  directory mask = 0777
```

It is highly recommended to look at the man pages for Samba and configure it ourselves and experiment with the settings. We will then discover potential aspects that will be interesting for us as a penetration tester. In addition, the more familiar we become with the Samba server and SMB, the easier it will be to find our way around the environment and use it for our purposes. Once we have adjusted `/etc/samba/smb.conf` to our needs, we have to restart the service on the server.
# Interact with SMB
_Restart Samba_
```shell
sudo systemctl restart smbd
```

_Connecting_
#smbclient
```shell
 smbclient -N -L //10.129.14.128
```

The Samba server now hosts five distinct shares, including the default ’`print$`’ and ’`IPC$`’ shares, established in the basic configuration. Focusing on the ’`[notes]`’ share, accessing and inspecting it through the client program allows for a closer examination. For those unfamiliar with the client program, leveraging the ’`help`’ command post-login reveals a comprehensive list of available commands, aiding navigation and execution within the share.

```shell
smbclient //10.129.14.128/notes
```

_Download_
Once we have discovered interesting files or folders, we can download them using the `get` command. Smbclient also allows us to execute local system commands using an exclamation mark at the beginning (`!<cmd>`) without interrupting the connection.

```shell
smb: \> get prep-prod.txt 

getting file \prep-prod.txt of size 71 as prep-prod.txt (8,7 KiloBytes/sec) 
(average 8,7 KiloBytes/sec)


smb: \> !ls

prep-prod.txt


smb: \> !cat prep-prod.txt

[] check your code with the templates
[] run code-assessment.py
[] …	
```

#### Samba Status


From an administrative perspective, ’`smbstatus`’ offers insights into active connections within the Samba server, displaying details such as connected clients, their originating hosts, and the accessed shares. This information becomes crucial, especially when navigating subnets or isolated networks accessible to others.

In domain-level security, the Samba server operates as part of a Windows domain, which typically includes at least one domain controller responsible for password authentication. The domain controller ensures secure authentication within the workgroup, managing user credentials in its `Security Authentication Module` (`SAM`). Upon user login and share access requests, these domain controllers authenticate users, enhancing security within the network.

```shell
Samba version 4.11.6-Ubuntu
PID     Username     Group        Machine                                   Protocol Version  Encryption           Signing              
----------------------------------------------------------------------------------------------------------------------------------------
75691   sambauser    samba        10.10.14.4 (ipv4:10.10.14.4:45564)      SMB3_11           -                    -                    

Service      pid     Machine       Connected at                     Encryption   Signing     
---------------------------------------------------------------------------------------------
notes        75691   10.10.14.4   Do Sep 23 00:12:06 2021 CEST     -            -           

No locked files
```

### Footprinting the Service

#### Nmap

[](https://github.com/MattiaCossu/FootprintingKnowledge/blob/main/readme.org#nmap-1)

```shell
sudo nmap 10.129.14.128 -sV -sC -p139,445

Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-19 15:15 CEST
Nmap scan report for sharing.inlanefreight.htb (10.129.14.128)
Host is up (0.00024s latency).

PORT    STATE SERVICE     VERSION
139/tcp open  netbios-ssn Samba smbd 4.6.2
445/tcp open  netbios-ssn Samba smbd 4.6.2
MAC Address: 00:00:00:00:00:00 (VMware)

Host script results:
|_nbstat: NetBIOS name: HTB, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-09-19T13:16:04
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 11.35 seconds
```

#### RPCclient

[](https://github.com/MattiaCossu/FootprintingKnowledge/blob/main/readme.org#rpcclient)

We can see from the results that it is not very much that Nmap provided us with here. Therefore, we should resort to other tools that allow us to interact manually with the SMB and send specific requests for the information. One of the handy tools for this is `rpcclient`. This is a tool to perform MS-RPC functions.

The [Remote Procedure Call](https://www.geeksforgeeks.org/remote-procedure-call-rpc-in-operating-system/) (`RPC`) is a concept and, therefore, also a central tool to realize operational and work-sharing structures in networks and client-server architectures. The communication process via RPC includes passing parameters and the return of a function value.

```shell
rpcclient -U "" 10.129.14.128

Enter WORKGROUP\'s password:
rpcclient $> 
```

The `rpcclient` offers us many different requests with which we can execute specific functions on the SMB server to get information. A complete list of all these functions can be found on the man page of the rpcclient.

|Query|Description|
|---|---|
|srvinfo|Server information.|
|enumdomains|Enumerate all domains deployed in the network.|
|querydominfo|Provides domain, server, and user information of deployed domains.|
|netshareenumall|Enumerates all available shares.|
|netsharegetinfo <share>|Provides information about a specific share.|
|enumdomusers|Enumerates all domain users.|
|queryuser <RID>|Provides information about a specific user.|

#### RPCclient - Enumeration

[](https://github.com/MattiaCossu/FootprintingKnowledge/blob/main/readme.org#rpcclient---enumeration)

```shell
rpcclient $> srvinfo

	  DEVSMB         Wk Sv PrQ Unx NT SNT DEVSM
	  platform_id     :       500
	  os version      :       6.1
	  server type     :       0x809a03
		
		
rpcclient $> enumdomains

name:[DEVSMB] idx:[0x0]
name:[Builtin] idx:[0x1]


rpcclient $> querydominfo

Domain:         DEVOPS
Server:         DEVSMB
Comment:        DEVSM
Total Users:    2
Total Groups:   0
Total Aliases:  0
Sequence No:    1632361158
Force Logoff:   -1
Domain Server State:    0x1
Server Role:    ROLE_DOMAIN_PDC
Unknown 3:      0x1


rpcclient $> netshareenumall

netname: print$
	  remark: Printer Drivers
	  path:   C:\var\lib\samba\printers
	  password:
netname: home
	  remark: INFREIGHT Samba
	  path:   C:\home\
	  password:
netname: dev
	  remark: DEVenv
	  path:   C:\home\sambauser\dev\
	  password:
netname: notes
	  remark: CheckIT
	  path:   C:\mnt\notes\
	  password:
netname: IPC$
	  remark: IPC Service (DEVSM)
	  path:   C:\tmp
	  password:
		
		
rpcclient $> netsharegetinfo notes

netname: notes
	  remark: CheckIT
	  path:   C:\mnt\notes\
	  password:
	  type:   0x0
	  perms:  0
	  max_uses:       -1
	  num_uses:       1
revision: 1
type: 0x8004: SEC_DESC_DACL_PRESENT SEC_DESC_SELF_RELATIVE 
DACL
	  ACL     Num ACEs:       1       revision:       2
	  ---
	  ACE
		  type: ACCESS ALLOWED (0) flags: 0x00 
		  Specific bits: 0x1ff
		  Permissions: 0x101f01ff: Generic all access SYNCHRONIZE_ACCESS WRITE_OWNER_ACCESS WRITE_DAC_ACCESS READ_CONTROL_ACCESS DELETE_ACCESS 
		  SID: S-1-1-0
```

The examples provided highlight the potential information leakage to `anonymous users` within a network. Granting access to network services to anonymous users can inadvertently expose critical information or grant excessive permissions, posing a significant risk to the entire network’s security.

Anonymous access not only jeopardizes the network but also facilitates the discovery of other users, potentially leading to aggressive brute-force attacks. Human error, coupled with inadequate security awareness and lax password practices, often results in weak passwords vulnerable to easy cracking.

#### Rpcclient - User Enumeration

[](https://github.com/MattiaCossu/FootprintingKnowledge/blob/main/readme.org#rpcclient---user-enumeration)

To illustrate user enumeration, the ‘rpcclient’ tool can be employed, showcasing how attackers could exploit vulnerabilities to enumerate users within the network.

```shell
rpcclient $> enumdomusers

user:[mrb3n] rid:[0x3e8]
user:[cry0l1t3] rid:[0x3e9]


rpcclient $> queryuser 0x3e9

	  User Name   :   cry0l1t3
	  Full Name   :   cry0l1t3
	  Home Drive  :   \\devsmb\cry0l1t3
	  Dir Drive   :
	  Profile Path:   \\devsmb\cry0l1t3\profile
	  Logon Script:
	  Description :
	  Workstations:
	  Comment     :
	  Remote Dial :
	  Logon Time               :      Do, 01 Jan 1970 01:00:00 CET
	  Logoff Time              :      Mi, 06 Feb 2036 16:06:39 CET
	  Kickoff Time             :      Mi, 06 Feb 2036 16:06:39 CET
	  Password last set Time   :      Mi, 22 Sep 2021 17:50:56 CEST
	  Password can change Time :      Mi, 22 Sep 2021 17:50:56 CEST
	  Password must change Time:      Do, 14 Sep 30828 04:48:05 CEST
	  unknown_2[0..31]...
	  user_rid :      0x3e9
	  group_rid:      0x201
	  acb_info :      0x00000014
	  fields_present: 0x00ffffff
	  logon_divs:     168
	  bad_password_count:     0x00000000
	  logon_count:    0x00000000
	  padding1[0..7]...
	  logon_hrs[0..21]...


rpcclient $> queryuser 0x3e8

	  User Name   :   mrb3n
	  Full Name   :
	  Home Drive  :   \\devsmb\mrb3n
	  Dir Drive   :
	  Profile Path:   \\devsmb\mrb3n\profile
	  Logon Script:
	  Description :
	  Workstations:
	  Comment     :
	  Remote Dial :
	  Logon Time               :      Do, 01 Jan 1970 01:00:00 CET
	  Logoff Time              :      Mi, 06 Feb 2036 16:06:39 CET
	  Kickoff Time             :      Mi, 06 Feb 2036 16:06:39 CET
	  Password last set Time   :      Mi, 22 Sep 2021 17:47:59 CEST
	  Password can change Time :      Mi, 22 Sep 2021 17:47:59 CEST
	  Password must change Time:      Do, 14 Sep 30828 04:48:05 CEST
	  unknown_2[0..31]...
	  user_rid :      0x3e8
	  group_rid:      0x201
	  acb_info :      0x00000010
	  fields_present: 0x00ffffff
	  logon_divs:     168
	  bad_password_count:     0x00000000
	  logon_count:    0x00000000
	  padding1[0..7]...
	  logon_hrs[0..21]...
```

#### Rpcclient - Group Information

[](https://github.com/MattiaCossu/FootprintingKnowledge/blob/main/readme.org#rpcclient---group-information)

We can then use the results to identify the group’s RID, which we can then use to retrieve information from the entire group.

```shell
rpcclient $> querygroup 0x201

	  Group Name:     None
	  Description:    Ordinary Users
	  Group Attribute:7
	  Num Members:2
```

#### Brute Forcing User RIDs

[](https://github.com/MattiaCossu/FootprintingKnowledge/blob/main/readme.org#brute-forcing-user-rids)

```shell
for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done

	  User Name   :   sambauser
	  user_rid :      0x1f5
	  group_rid:      0x201
		
	  User Name   :   mrb3n
	  user_rid :      0x3e8
	  group_rid:      0x201
		
	  User Name   :   cry0l1t3
	  user_rid :      0x3e9
	  group_rid:      0x201
```

#### Impacket - Samrdump.py

[](https://github.com/MattiaCossu/FootprintingKnowledge/blob/main/readme.org#impacket---samrdumppy)

An alternative to this would be a Python script from [Impacket](https://github.com/SecureAuthCorp/impacket) called [samrdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/samrdump.py).

```shell
samrdump.py 10.129.14.128

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Retrieving endpoint list from 10.129.14.128
Found domain(s):
 . DEVSMB
 . Builtin
[*] Looking up users in domain DEVSMB
Found user: mrb3n, uid = 1000
Found user: cry0l1t3, uid = 1001
mrb3n (1000)/FullName: 
mrb3n (1000)/UserComment: 
mrb3n (1000)/PrimaryGroupId: 513
mrb3n (1000)/BadPasswordCount: 0
mrb3n (1000)/LogonCount: 0
mrb3n (1000)/PasswordLastSet: 2021-09-22 17:47:59
mrb3n (1000)/PasswordDoesNotExpire: False
mrb3n (1000)/AccountIsDisabled: False
mrb3n (1000)/ScriptPath: 
cry0l1t3 (1001)/FullName: cry0l1t3
cry0l1t3 (1001)/UserComment: 
cry0l1t3 (1001)/PrimaryGroupId: 513
cry0l1t3 (1001)/BadPasswordCount: 0
cry0l1t3 (1001)/LogonCount: 0
cry0l1t3 (1001)/PasswordLastSet: 2021-09-22 17:50:56
cry0l1t3 (1001)/PasswordDoesNotExpire: False
cry0l1t3 (1001)/AccountIsDisabled: False
cry0l1t3 (1001)/ScriptPath: 
[*] Received 2 entries.
```

The information we have already obtained with `rpcclient` can also be obtained using other tools. For example, the [SMBMap](https://github.com/ShawnDEvans/smbmap) and [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec) tools are also widely used and helpful for the enumeration of SMB services.

#### SMBmap

[](https://github.com/MattiaCossu/FootprintingKnowledge/blob/main/readme.org#smbmap)

```shell
smbmap -H 10.129.14.128

[+] Finding open SMB ports....
[+] User SMB session established on 10.129.14.128...
[+] IP: 10.129.14.128:445       Name: 10.129.14.128                                     
	  Disk                                                    Permissions     Comment
	  ----                                                    -----------     -------
	  print$                                                  NO ACCESS       Printer Drivers
	  home                                                    NO ACCESS       INFREIGHT Samba
	  dev                                                     NO ACCESS       DEVenv
	  notes                                                   NO ACCESS       CheckIT
	  IPC$                                                    NO ACCESS       IPC Service (DEVSM)
```

#### CrackMapExec

[](https://github.com/MattiaCossu/FootprintingKnowledge/blob/main/readme.org#crackmapexec)

```shell
crackmapexec smb 10.129.14.128 --shares -u '' -p ''

SMB         10.129.14.128   445    DEVSMB           [*] Windows 6.1 Build 0 (name:DEVSMB) (domain:) (signing:False) (SMBv1:False)
SMB         10.129.14.128   445    DEVSMB           [+] \: 
SMB         10.129.14.128   445    DEVSMB           [+] Enumerated shares
SMB         10.129.14.128   445    DEVSMB           Share           Permissions     Remark
SMB         10.129.14.128   445    DEVSMB           -----           -----------     ------
SMB         10.129.14.128   445    DEVSMB           print$                          Printer Drivers
SMB         10.129.14.128   445    DEVSMB           home                            INFREIGHT Samba
SMB         10.129.14.128   445    DEVSMB           dev                             DEVenv
SMB         10.129.14.128   445    DEVSMB           notes           READ,WRITE      CheckIT
SMB         10.129.14.128   445    DEVSMB           IPC$                            IPC Service (DEVSM)
```

#### enum4linux

[](https://github.com/MattiaCossu/FootprintingKnowledge/blob/main/readme.org#enum4linux)

Another tool worth mentioning is the so-called [enum4linux-ng](https://github.com/cddmp/enum4linux-ng), which is based on an older tool, enum4linux. This tool automates many of the queries, but not all, and can return a large amount of information.

##### Install

[](https://github.com/MattiaCossu/FootprintingKnowledge/blob/main/readme.org#install)

```shell
git clone https://github.com/cddmp/enum4linux-ng.git
cd enum4linux-ng
pip3 install -r requirements.txt
```

##### Enumeration

[](https://github.com/MattiaCossu/FootprintingKnowledge/blob/main/readme.org#enumeration)

```shell
./enum4linux-ng.py 10.179.114.128 -A
```