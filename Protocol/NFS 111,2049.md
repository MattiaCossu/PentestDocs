# Knowledge
`Network File System` (`NFS`) is a network file system developed by Sun Microsystems and has the same purpose as **SMB**. Its purpose is to access file systems over a network as if they were local. NFS is used between Linux and Unix systems. This means that NFS clients cannot communicate directly with SMB servers.

|Version|Features|
|---|---|
|NFSv2|Older version widely supported by many systems; originally operated solely over UDP.|
|NFSv3|Offers additional features like variable file size, improved error reporting, but lacks full compatibility with NFSv2 clients.|
|NFSv4|Introduces Kerberos authentication, functions efficiently across firewalls and the internet, eliminates portmappers, supports ACLs, applies state-based operations, enhances performance, and prioritizes high security. First version with a stateful protocol.|

A significant advantage of `NFSv4` over its predecessors is that only one UDP or TCP port `2049` is used to run the service, which simplifies the use of the protocol across firewalls. NFS is based on the Open Network Computing Remote Procedure Call (`ONC-RPC` / `SUN-RPC`) protocol exposed on `TCP` and `UDP` ports `111`, which uses External Data Representation (`XDR`) for the system-independent exchange of data. The NFS protocol has no mechanism for `authentication` or `authorization`. The most common authentication is via UNIX `UID` / `GID` and `group memberships`, which is why this syntax is most likely to be applied to the NFS protocol.
# Default Configuration
#configuration
The configuration are provided into `/etc/exports`, the file is like:

```shell
# /etc/exports: the access control list for filesystems which may be exported
#               to NFS clients.  See exports(5).
#
# Example for NFSv2 and NFSv3:
# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)
#
# Example for NFSv4:
# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)
# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)
```

Some possible `configuration`:

|Option|Description|
|---|---|
|rw|Read and write permissions.|
|ro|Read-only permissions.|
|sync|Synchronous data transfer, albeit slightly slower.|
|async|Asynchronous data transfer, offering slightly faster speeds.|
|secure|Restricts the use of ports above 1024.|
|insecure|Allows the use of ports above 1024.|
|no_subtree_check|Disables the checking of subdirectory trees, potentially enhancing performance.|
|root_squash|Maps all permissions from root UID/GID 0 to the UID/GID of anonymous, securing root access on NFS mounts.|

#### ExportFS
```shell
echo '/mnt/nfs  10.129.14.0/24(sync,no_subtree_check)' >> /etc/exports
systemctl restart nfs-kernel-server
exportfs
```

We have shared the folder `/mnt/nfs` to the subnet `10.129.14.0/24` with the setting shown above

## Dangerous Settings
Here are some of them listed:

|Option|Description|
|---|---|
|rw|Grants both read and write permissions.|
|insecure|Permits the utilization of ports above 1024 for NFS operations.|
|nohide|Ensures that if another filesystem is mounted below an exported directory, it gets its own exports entry.|
|no_root_squash|Retains files created by root with the UID/GID 0, bypassing the usual mapping to anonymous UID/GID for security.|

We can take a look at the insecure option. This is dangerous because users can use ports above 1024. The first 1024 ports can only be used by root. This prevents the fact that no users can use sockets above port 1024 for the NFS service and interact with it.

### Footprinting the Service
## Nmap
#nmap
```shell
sudo nmap 10.129.14.128 -p111,2049 -sV -sC
```

The `rpcinfo` NSE script retrieves a list of all currently running RPC services, their names and descriptions, and the ports they use.

```shell
sudo nmap --script nfs* 10.129.14.128 -sV -p111,2049
```

_Show Mount_
```bash
sudo nmap --script nfs-showmount 10.129.14.128 -sV -p111,2049
```
## Show Available NFS Shares

```shell
showmount -e 10.129.14.128
```

### Mounting NFS Share
```shell
mkdir target-NFS
sudo mount -t nfs 10.129.14.128:/ ./target-NFS/ -o nolock
cd target-NFS
treee .
```

_List Contents with Usernames & Group Names_
```shell
ls -l mnt/nfs/
```

_List Contents with UIDs & GUIDs_
```shell
ls -n mnt/nfs/
```
### Unmounting
```shell
cd ..
sudo umount ./target-NFS
``` 