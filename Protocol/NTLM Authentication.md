#hash
# Knowledge 
In windows other #LDAP and #KERBEROS, AD uses  uses several other authentication methods which can be used (and abused) by applications and services in AD. These include #LM, #NTLM, #NTLMv1, and #NTLMv2.

#LM and #NTLM here are the hash names.
#NTLMv1 and #NTLMv2 are authentication protocols that utilize the LM or NT hash.

_Hash Protocol Comparison_

|**Hash/Protocol**|**Cryptographic technique**|**Mutual Authentication**|**Message Type**|**Trusted Third Party**|
|---|---|---|---|---|
|`NTLM`|Symmetric key cryptography|No|Random number|Domain Controller|
|`NTLMv1`|Symmetric key cryptography|No|MD4 hash, random number|Domain Controller|
|`NTLMv2`|Symmetric key cryptography|No|MD4 hash, random number|Domain Controller|
|`Kerberos`|Symmetric key cryptography & asymmetric cryptography|Yes|Encrypted ticket using DES, MD5|Domain Controller/Key Distribution Center (KDC)|
## Hash
#hash 
### LN
#LM
`LAN Manager` (LM or LANMAN) hashes are the oldest password storage mechanism used by the Windows operating system.

An LM hash takes the form of `299bd128c1101fd6`.

If in use, they are stored 
- in the _SAM database_ on a ==Windows host==,
- in the _NTDS.DIT_ database on a ==Domain Controller==.

Passwords using LM are ==limited== to a maximum of `14` characters.
Passwords are ==not case sensitive== and are ==converted to uppercase== before generating the hashed value, limiting the keyspace to a total of 69 characters making it relatively easy to crack these hashes using a tool such as #hashcat or #jhon.
#### How it works?
Before hashing, a 14 character password is first split into two seven-character chunks. If the password is less than fourteen characters, it will be padded with NULL characters to reach the correct value. Two DES keys are created from each chunk. These chunks are then encrypted using the string `KGS!@#$%`, creating two 8-byte ciphertext values. These two values are then concatenated together, resulting in an LM hash.

---
### NTHash (NTLM)
#NTLM 
`NT LAN Manager` (NTLM) hashes are used on modern Windows systems.
It support the ==entire Unicode character== set of 65,536 characters.

An NT hash takes the form of `b4b9b02e6f09a9bd760f388b67351e2b`, which is the second half of the full NTLM hash. An NTLM hash looks like this:
```text
Rachel:500:aad3c435b514a4eeaad3b935b51304fe:e46b9e548fa0d122de7f59fb6d48eaa2:::
```

Looking at the hash above, we can break the NTLM hash down into its individual parts:
- `Rachel` is the username
- `500` is the Relative Identifier (RID). 500 is the known RID for the `administrator` account
- `aad3c435b514a4eeaad3b935b51304fe` is the LM hash and, if LM hashes are disabled on the system, can not be used for anything
- `e46b9e548fa0d122de7f59fb6d48eaa2` is the NT hash.
#### How it works?
It is a challenge-response authentication protocol and uses three messages to authenticate:
1. A client first sends a `NEGOTIATE_MESSAGE` to the server,
2. A server response is a `CHALLENGE_MESSAGE` to verify the client's identity,
3. A client responds with an `AUTHENTICATE_MESSAGE`.

![[NTLM Process.png]]

---
## Protocol
###  NTLMv1 (Net-NTLMv1)
#NTLMv1 
The NTLM protocol performs a challenge/response between a server and client using the NT hash using both #NT and #LM #hash.

An full NTLMv1 hash looks like:
```text
u4-netntlm::kNS:338d08f8e26de93300000000000000000000000000000000:9526fb8c23a90751cdd619b6cea564742e1e4bf33006ba41:cb8086049ec4736c
```
#### How it works?
The protocol is used for network authentication, and the Net-NTLMv1 hash itself is created from a challenge/response algorithm. The server sends the client an 8-byte random number (challenge), and the client returns a 24-byte response. These hashes can NOT be used for pass-the-hash attacks. The algorithm looks as follows:

_V1 Challenge & Response Algorithm_
```text
C = 8-byte server challenge, random
K1 | K2 | K3 = LM/NT-hash | 5-bytes-0
response = DES(K1,C) | DES(K2,C) | DES(K3,C)
```
---
### NTLMv2 (Net-NTLMv2)
#NTLMv2 
It is hardened against certain spoofing attacks that NTLMv1 is susceptible to.

An example of an NTLMv2 hash is:
```text
admin::N46iSNekpT:08ca45b7d7ea58ee:88dcbe4446168966a153a0064958dac6:5c7830315c7830310000000000000b45c67103d07d7b95acd12ffa11230e0000000052920b85f78d013c31cdb3b92f5d765c783030
```
#### How it works?
NTLMv2 sends two responses to the 8-byte challenge received by the server. These responses contain a 16-byte HMAC-MD5 hash of the challenge, a randomly generated challenge from the client, and an HMAC-MD5 hash of the user's credentials. A second response is sent, using a variable-length client challenge including the current time, an 8-byte random value, and the domain name. The algorithm is as follows:

_V2 Challenge & Response Algorithm_
```text
SC = 8-byte server challenge, random
CC = 8-byte client challenge, random
CC* = (X, time, CC2, domain name)
v2-Hash = HMAC-MD5(NT-Hash, user name, domain name)
LMv2 = HMAC-MD5(v2-Hash, SC, CC)
NTv2 = HMAC-MD5(v2-Hash, SC, CC*)
response = LMv2 | CC | NTv2 | CC*
```
---

### Domain Cached Credentials (MSCache2)
Microsoft developed the [MS Cache v1 and v2](https://webstersprodigy.net/2014/02/03/mscash-hash-primer-for-pentesters/) algorithm (also known as `Domain Cached Credentials` (DCC) to solve the potential issue of a domain-joined host being unable to communicate with a domain controller (i.e., due to a network outage or other technical issue) and, hence, NTLM/Kerberos authentication not working to access the host in question. Hosts save the last `ten` hashes for any domain users that successfully log into the machine in the `HKEY_LOCAL_MACHINE\SECURITY\Cache` registry key. These hashes cannot be used in pass-the-hash attacks. Furthermore, the hash is very slow to crack with a tool such as Hashcat, even when using an extremely powerful GPU cracking rig, so attempts to crack these hashes typically need to be extremely targeted or rely on a very weak password in use. These hashes can be obtained by an attacker or pentester after gaining local admin access to a host and have the following format: `$DCC2$10240#bjones#e4e938d12fe5974dc42a90120bd9c90f`.